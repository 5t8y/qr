<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Tạo mã QR — Chuẩn (kèm xử lý logo ngân hàng)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --muted:#6b7280; --primary:#0b1220; --accent:#2563eb;
      --border:#e6e9ef; --rounded:18px; --mobile-panel-height:480px;
    }
    *{box-sizing:border-box;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--primary);-webkit-font-smoothing:antialiased}
    body{padding:18px 12px 32px;}
    .wrap{max-width:920px;margin:0 auto}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 12px 30px rgba(15,23,42,0.06);border:1px solid rgba(16,24,40,0.04)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    header h1{margin:0;font-size:18px;font-weight:700}
    header p{margin:0;color:var(--muted);font-size:13px}

    form{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px 14px;margin-bottom:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-weight:600;font-size:13px}
    input,select,textarea{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fbfdff;font-size:14px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 6px rgba(37,99,235,0.06)}
    .hint{font-size:12px;color:var(--muted)}

    .actions{grid-column:1/-1;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--accent);border:1px solid var(--border)}
    .btn.small{padding:8px 10px;font-size:13px}

    .result{display:grid;grid-template-columns:1.4fr 1fr;gap:16px;align-items:start}
    .result-block{background:linear-gradient(180deg,#fff,#fcfdff);border-radius:12px;padding:12px;border:1px solid var(--border)}
    .result-block h2{margin:0 0 8px 0;font-size:15px}
    textarea#payload{min-height:80px;resize:vertical;border-radius:8px;font-family:monospace;background:#fbfdff}

    /* preview card */
    .qr-card { width: 100%; max-width: 460px; margin: 0 auto; border-radius: 18px; background: #fff; padding: 12px 18px 24px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.06); border: 1px solid rgba(16,24,40,0.04); display:flex; flex-direction:column;
    }
    .card-title { text-align:center; font-weight:700; font-size:16px; color:#0b1220; margin-bottom:8px; }

    .qr-area { position: relative; width: 320px; height: 320px; margin: 6px auto 10px; border-radius: 18px; background: #fff; }
    .qr-area::before { content:''; position:absolute; inset:-8px; border-radius:24px; background: linear-gradient(180deg, rgba(240,246,255,0.6), rgba(246,249,255,0.4)); opacity:0.6; filter: blur(6px); z-index:0; }
    .qr-inner { position:absolute; inset:18px; border-radius:14px; background:#fff; box-shadow: 0 8px 18px rgba(15,23,42,0.04); display:flex; align-items:center; justify-content:center; overflow:hidden; }
    #qrcode img,#qrcode canvas{width:100%;height:100%;display:block;border-radius:12px; z-index:1}
    .qr-placeholder{position:absolute;inset:18px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px; z-index:1}

    #logoPreview { position:absolute; z-index:2; width:26%; height:26%; left:50%; top:50%; transform:translate(-50%,-50%); border-radius:999px; object-fit:cover; display:none;
      background:#fff; padding:6px; box-shadow:0 6px 18px rgba(15,23,42,0.06); border:8px solid #ffffff;
    }

    /* bank inline: logo left, title right */
    .bank-meta-inline { display:flex; align-items:center; gap:12px; justify-content:center; margin-top:8px; }
    .bank-logo { width:44px; height:44px; border-radius:10px; object-fit:contain; background:#fff; padding:6px; border:1px solid var(--border); box-shadow:0 6px 18px rgba(15,23,42,0.04); }
    .bank-title { font-weight:700; font-size:14px; text-align:left; color:#0b1220; max-width:300px; line-height:1.12; }

    .bank-error { color:#b91c1c; font-size:12px; text-align:center; margin-top:6px; display:none; }

    .info-table { width:100%; margin-top:12px; }
    .info-row { display:flex; justify-content:space-between; align-items:center; padding:8px 6px; border-top:1px solid rgba(0,0,0,0.03); }
    .info-row:first-child { border-top:0; }
    .info-label { color:var(--muted); font-size:12px; }
    .info-value { font-weight:800; font-size:14px; color:#0b1220; text-align:right; min-width:120px; }

    .combined { margin-top:12px; text-align:center; font-weight:800; font-size:14px; color:#0b1220; }

    .card-footer-note { margin-top:8px; text-align:center; font-size:12px; color:rgba(11,18,32,0.55); }

    .final-image{ max-width:100%; border-radius:14px; box-shadow:0 18px 40px rgba(0,0,0,0.06); border:1px solid rgba(16,24,40,0.04); display:block; margin:12px auto; }

    @media(max-width:720px){
      body{ padding-bottom: calc(var(--mobile-panel-height) + 20px); }
      .result{ display:block; }
      .qr-area{ width:260px; height:260px; }
      #logoPreview{ width:28%; height:28%; border-width:7px; }
      .bank-logo{ width:40px; height:40px; }
      .bank-title{ font-size:13px; max-width:220px; }
      .info-value{ font-size:13px; min-width:100px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>Tạo mã QR thanh toán VietQR</h1>
          <p style="margin:0;color:var(--muted);font-size:13px">Phiên bản chuẩn — xử lý logo ngân hàng an toàn (CORS-safe)</p>
        </div>
      </header>

      <form id="qr-form" autocomplete="off" novalidate>
        <div class="field">
          <label>Ngân hàng (bắt buộc)</label>
          <select id="bankSelect" required>
            <option value="">— Chọn ngân hàng —</option>
          </select>
          <div class="hint">Dùng API public VietQR để lấy BIN (acquirer ID).</div>
        </div>

        <div class="field"><label>Số tài khoản nhận</label><input id="accountNumber" required placeholder="Ví dụ: 087332665"/></div>
        <div class="field"><label>Tên chủ tài khoản</label><input id="accountName" required placeholder="BUI DIEU HUONG"/></div>
        <div class="field"><label>Số tiền (VND)</label><input id="amount" type="number" min="0" step="1" placeholder="Ví dụ: 5.545.345"/></div>
        <div class="field"><label>Nội dung chuyển khoản</label><input id="description"/></div>
        <div class="field"><label>Mã cửa hàng</label><input id="storeCode" placeholder="IN&Fun Studio"/></div>
        <div class="field"><label>Mã đơn hàng</label><input id="orderCode" placeholder="HSJ-34234"/></div>

        <div class="field"><label>Logo ở giữa QR (tùy chọn)</label><input type="file" id="logoInput" accept="image/*"/></div>

        <div class="field">
          <label>
            <input type="checkbox" id="includeBankLogo" checked /> Chèn logo ngân hàng vào ảnh xuất (có thể bị chặn bởi CORS)
          </label>
          <div class="hint">Bỏ chọn nếu logo ngân hàng từ server không có header CORS.</div>
        </div>

        <div id="error" style="display:none;color:#b91c1c"></div>

        <div class="actions">
          <button class="btn" type="submit">Tạo mã QR</button>
          <button class="btn ghost" type="button" id="clearBtn">Xóa / làm mới</button>
          <button class="btn ghost small" type="button" id="downloadBtn">Tải QR (PNG)</button>
          <button class="btn ghost small" type="button" id="copyPayloadBtn">Sao chép chuỗi EMV</button>
        </div>
      </form>

      <div class="result">
        <div class="result-block">
          <h2>Chuỗi dữ liệu VietQR (EMV payload)</h2>
          <textarea id="payload" readonly></textarea>
          <div class="hint">Chuỗi này mã hoá theo EMVCo / VietQR. Kiểm tra trên app ngân hàng trước khi sử dụng thật.</div>
        </div>

        <div class="result-block" id="previewColumn">
          <h2>QR hiển thị</h2>

          <div id="previewCard" class="qr-card">
            <div class="card-title">Thông Tin Thanh Toán</div>

            <div class="qr-area">
              <div class="qr-inner" id="qrInner">
                <div id="qrcode"></div>
                <div class="qr-placeholder" id="qrPlaceholder">QR sẽ hiển thị sau khi bấm “Tạo mã QR”</div>
              </div>
              <img id="logoPreview" alt="logo giữa"/>
            </div>

            <div id="bankMeta" class="bank-meta-inline"></div>
            <div id="bankError" class="bank-error">Logo ngân hàng không thể chèn vào ảnh do CORS — sử dụng placeholder.</div>

            <div class="info-table" id="infoTable"></div>
            <div class="combined" id="combinedText" style="display:none"></div>

            <div class="card-footer-note" id="cardFooterNote">In&Fun Studio - Xưởng Khắc dấu, In ấn, Thiết kế theo yêu cầu</div>
          </div>

          <div id="finalImageContainer" style="width:100%;display:flex;justify-content:center"></div>

          <div style="font-size:12px;color:var(--muted);margin-top:8px">Chuột phải → Lưu hình ảnh (ảnh đã ghép sẵn)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
  /* ----------------- HELPERS ----------------- */
  function measureTextWidth(text, font){
    const c = document.createElement('canvas');
    const ctx = c.getContext('2d');
    ctx.font = font;
    return ctx.measureText(text).width;
  }

  function roundRect(ctx,x,y,w,h,r){
    const radius = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+radius,y);
    ctx.arcTo(x+w,y,x+w,y+radius,radius);
    ctx.arcTo(x+w,y+h,x+w-radius,y+h,radius);
    ctx.arcTo(x,y+h,x,y+h-radius,radius);
    ctx.arcTo(x,y,x+radius,y,radius);
    ctx.closePath();
  }

  async function drawImageToCanvas(ctx, srcOrEl, x,y,w,h){
    if(!srcOrEl) return;
    if(typeof srcOrEl === 'string' && srcOrEl.startsWith('data:')){
      const img = new Image(); img.src = srcOrEl; await new Promise((r,rej)=>{ img.onload=r; img.onerror=rej; }); ctx.drawImage(img,x,y,w,h); return;
    }
    if(srcOrEl.tagName && srcOrEl.tagName.toLowerCase()==='canvas'){ ctx.drawImage(srcOrEl,x,y,w,h); return; }
    const img = new Image(); img.crossOrigin = 'anonymous';
    if(typeof srcOrEl === 'string') img.src = srcOrEl; else if(srcOrEl.src) img.src = srcOrEl.src; else img.src = srcOrEl;
    await new Promise((r,rej)=>{ img.onload=r; img.onerror=rej; });
    ctx.drawImage(img,x,y,w,h);
  }

  async function drawImageContain(ctx, srcOrEl, x,y,w,h){
    const img = new Image(); img.crossOrigin = 'anonymous';
    if(typeof srcOrEl === 'string') img.src = srcOrEl; else if(srcOrEl.src) img.src = srcOrEl.src; else img.src = srcOrEl;
    await new Promise((r,rej)=>{ img.onload=r; img.onerror=rej; });
    const iw = img.naturalWidth, ih = img.naturalHeight;
    const scale = Math.min(w/iw, h/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = x + (w - dw)/2, dy = y + (h - dh)/2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  async function fetchImageAsDataURL(url){
    if(!url) return null;
    if(url.startsWith && url.startsWith('data:')) return url;
    try{
      const resp = await fetch(url, { mode:'cors' });
      if(!resp.ok) throw new Error('HTTP ' + resp.status);
      const blob = await resp.blob();
      return await new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload = ()=>res(fr.result); fr.onerror = rej; fr.readAsDataURL(blob); });
    }catch(e){
      console.warn('fetchImageAsDataURL failed', e);
      return null;
    }
  }

  async function drawCircularImage(ctx, src, cx, cy, radius, border=8){
    const img = new Image(); img.crossOrigin='anonymous'; img.src = src;
    await new Promise((r,rej)=>{ img.onload=r; img.onerror=rej; });
    ctx.fillStyle = '#ffffff';
    ctx.beginPath(); ctx.arc(cx, cy, radius + border/2, 0, 2*Math.PI); ctx.closePath(); ctx.fill();
    ctx.save(); ctx.beginPath(); ctx.arc(cx, cy, radius, 0, 2*Math.PI); ctx.closePath(); ctx.clip();
    const iw = img.naturalWidth, ih = img.naturalHeight;
    const scale = Math.max((radius*2)/iw, (radius*2)/ih);
    const dw = iw*scale, dh = ih*scale; const dx = cx - dw/2, dy = cy - dh/2;
    ctx.drawImage(img, dx, dy, dw, dh);
    ctx.restore();
    ctx.beginPath(); ctx.arc(cx, cy, radius, 0, 2*Math.PI); ctx.closePath(); ctx.lineWidth = border; ctx.strokeStyle = '#ffffff'; ctx.stroke();
  }

  /* ----------------- TLV/CRC ----------------- */
  function tlv(id, value){ const length = value.length; if(length>99) throw new Error('TLV quá dài'); return id + String(length).padStart(2,'0') + value; }
  function crc16CCITT(str){ let crc=0xFFFF; for(let i=0;i<str.length;i++){ crc ^= str.charCodeAt(i) << 8; for(let j=0;j<8;j++){ if(crc & 0x8000) crc = (crc << 1) ^ 0x1021; else crc <<= 1; crc &= 0xFFFF; } } return crc.toString(16).toUpperCase().padStart(4,'0'); }
  function buildVietQRPayload({ acqId, accountNumber, accountName, amount, description }){
    if(!acqId||!accountNumber) throw new Error('Thiếu BIN hoặc số tài khoản');
    acqId=String(acqId).trim(); accountNumber=String(accountNumber).trim(); accountName=accountName?String(accountName).trim():""; description=description?String(description).trim():"";
    const parts=[]; parts.push(tlv('00','01'));
    const hasAmount = amount !== undefined && amount !== null && String(amount).trim()!=='' && Number(amount)>0;
    parts.push(tlv('01', hasAmount ? '12' : '11'));
    const guid = tlv('00','A000000727'); const beneficiary = tlv('00', acqId) + tlv('01', accountNumber); const beneficiaryWrapper = tlv('01', beneficiary);
    const serviceCode = tlv('02','QRIBFTTA'); parts.push(tlv('38', guid + beneficiaryWrapper + serviceCode));
    parts.push(tlv('52','0000')); parts.push(tlv('53','704'));
    if(hasAmount){ const amtInt=Math.round(Number(amount)); if(amtInt>0) parts.push(tlv('54', String(amtInt))); }
    parts.push(tlv('58','VN'));
    if(accountName) parts.push(tlv('59', accountName.toUpperCase()));
    if(description) parts.push(tlv('62', tlv('08', description)));
    const data = parts.join(''); const dataForCRC = data + '63' + '04'; const crc = crc16CCITT(dataForCRC);
    return dataForCRC + crc;
  }

  /* ----------------- DOM refs ----------------- */
  const bankSelect = document.getElementById('bankSelect');
  const accountNumberInput = document.getElementById('accountNumber');
  const accountNameInput = document.getElementById('accountName');
  const amountInput = document.getElementById('amount');
  const descriptionInput = document.getElementById('description');
  const orderCodeInput = document.getElementById('orderCode');
  const storeCodeInput = document.getElementById('storeCode');
  const logoInput = document.getElementById('logoInput');
  const logoPreview = document.getElementById('logoPreview');
  const includeBankLogoCheckbox = document.getElementById('includeBankLogo');
  const bankErrorEl = document.getElementById('bankError');

  const previewCard = document.getElementById('previewCard');
  const qrPlaceholder = document.getElementById('qrPlaceholder');
  const finalImageContainer = document.getElementById('finalImageContainer');
  const bankMeta = document.getElementById('bankMeta');
  const infoTable = document.getElementById('infoTable');
  const combinedTextEl = document.getElementById('combinedText');
  const cardFooterNote = document.getElementById('cardFooterNote');
  const payloadTextarea = document.getElementById('payload');
  const errorBox = document.getElementById('error');

  let qrInstance = null;

  function showError(msg){ errorBox.textContent = msg; errorBox.style.display = msg ? 'block' : 'none'; }

  function clearPreviewAndFinal(){
    const qrcode = document.getElementById('qrcode'); qrcode.innerHTML = '';
    const existing = document.getElementById('finalImage'); if(existing) existing.remove();
    previewCard.style.display = 'block'; qrPlaceholder.style.display = 'flex';
    bankMeta.innerHTML = ''; infoTable.innerHTML = ''; combinedTextEl.style.display='none'; payloadTextarea.value='';
    bankErrorEl.style.display = 'none';
    showError('');
  }

  function renderQR(payload){
    clearPreviewAndFinal();
    const container = document.getElementById('qrcode');
    qrInstance = new QRCode(container, { text: payload, width: 260, height:260, correctLevel: QRCode.CorrectLevel.M });
    qrPlaceholder.style.display = 'none';
  }

  /* ----------------- create final image ----------------- */
  async function createFinalImageDataURL(){
    const qrcodeEl = document.querySelector('#qrcode img, #qrcode canvas');
    if(!qrcodeEl) throw new Error('Chưa có QR để xuất');

    const account = accountNumberInput.value || '';
    const name = accountNameInput.value || '';
    const amount = amountInput.value && Number(amountInput.value)>0 ? Number(amountInput.value).toLocaleString('vi-VN') + ' VND' : 'Không cố định';
    const store = storeCodeInput.value || '-';
    const order = orderCodeInput.value || '-';
    const combined = `${store} - ${order}`;
    const topTitle = 'Thông Tin Thanh Toán';
    const bottomNote = cardFooterNote.textContent || 'In&Fun Studio - Xưởng Khắc dấu, In ấn, Thiết kế theo yêu cầu';

    const cardPadding = 18;
    const topTitleHeight = 26;
    const bottomNoteHeight = 28;
    const qrBoxSize = 320;
    const qrMargin = 12;
    const bankLogoSize = 56;
    const bankTitleFont = '700 14px Inter, Arial';
    const infoValueFont = '700 14px Inter, Arial';
    const labelFont = '12px Inter, Arial';
    const combinedFont = '800 14px Inter, Arial';

    const bankTitleEl = document.querySelector('#bankMeta .bank-title');
    const bankTitleText = bankTitleEl && bankTitleEl.textContent ? bankTitleEl.textContent.trim() : '';

    const candidates = [
      measureTextWidth(account, infoValueFont),
      measureTextWidth(name.toUpperCase(), infoValueFont),
      measureTextWidth(amount, infoValueFont),
      measureTextWidth(combined, combinedFont),
      measureTextWidth(bankTitleText, bankTitleFont),
      measureTextWidth(topTitle, '700 16px Inter, Arial'),
      measureTextWidth(bottomNote, '12px Inter, Arial'),
      bankLogoSize
    ];
    const contentW = Math.max(qrBoxSize, ...candidates);
    const cardW = Math.round(contentW + cardPadding*2);

    const qrAreaH = qrBoxSize + qrMargin*2;
    const bankMetaH = bankLogoSize + 8 + 28;
    const infoRowsH = 3*(20) + 2*8;
    const cardH = Math.round(cardPadding + topTitleHeight + 8 + qrAreaH + 12 + bankMetaH + 8 + infoRowsH + 8 + bottomNoteHeight + cardPadding);

    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const canvas = document.createElement('canvas'); canvas.width = cardW * dpr; canvas.height = cardH * dpr;
    canvas.style.width = cardW + 'px'; canvas.style.height = cardH + 'px';
    const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);

    // card bg + shadow
    ctx.save(); ctx.shadowColor='rgba(0,0,0,0.06)'; ctx.shadowBlur=28; ctx.shadowOffsetY=6;
    roundRect(ctx, 0.5, 0.5, cardW-1, cardH-1, 18); ctx.fillStyle='#ffffff'; ctx.fill(); ctx.restore();
    ctx.strokeStyle='rgba(16,24,40,0.04)'; ctx.lineWidth=1; roundRect(ctx, 0.5, 0.5, cardW-1, cardH-1, 18); ctx.stroke();

    // top title
    let curY = cardPadding;
    ctx.fillStyle = '#0b1220'; ctx.font = '700 16px Inter, Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'top';
    ctx.fillText(topTitle, cardW/2, curY);
    curY += topTitleHeight + 8;

    // QR decorative ring
    const qrAreaX = Math.round((cardW - qrBoxSize)/2);
    const qrAreaY = curY;
    const ringW = 8;
    ctx.save(); ctx.shadowColor='rgba(0,0,0,0.06)'; ctx.shadowBlur=12; ctx.shadowOffsetY=4;
    roundRect(ctx, qrAreaX - ringW/2, qrAreaY - ringW/2, qrBoxSize + ringW, qrBoxSize + ringW, 20);
    ctx.strokeStyle = 'rgba(15,23,42,0.03)'; ctx.lineWidth = ringW; ctx.stroke(); ctx.restore();

    // inner QR
    roundRect(ctx, qrAreaX, qrAreaY, qrBoxSize, qrBoxSize, 14); ctx.fillStyle='#ffffff'; ctx.fill();
    ctx.strokeStyle='rgba(16,24,40,0.03)'; ctx.lineWidth=1; roundRect(ctx, qrAreaX, qrAreaY, qrBoxSize, qrBoxSize, 14); ctx.stroke();

    const qrInnerX = qrAreaX + qrMargin; const qrInnerY = qrAreaY + qrMargin; const qrInnerSize = qrBoxSize - qrMargin*2;
    ctx.save(); roundRect(ctx, qrInnerX, qrInnerY, qrInnerSize, qrInnerSize, 12); ctx.clip();
    const qEl = qrcodeEl;
    if(qEl && qEl.tagName && qEl.tagName.toLowerCase() === 'canvas') ctx.drawImage(qEl, qrInnerX, qrInnerY, qrInnerSize, qrInnerSize);
    else await drawImageToCanvas(ctx, qEl, qrInnerX, qrInnerY, qrInnerSize, qrInnerSize);
    ctx.restore();

    // center circular logo (cover)
    if(logoPreview && logoPreview.src && logoPreview.style.display !== 'none'){
      const radius = Math.round((qrInnerSize * 0.25)/2);
      const cx = qrInnerX + qrInnerSize/2, cy = qrInnerY + qrInnerSize/2;
      try{ await drawCircularImage(ctx, logoPreview.src, cx, cy, radius, 10); }catch(e){ console.warn('drawCircularImage failed', e); }
    }

    curY = qrAreaY + qrBoxSize + 12;

    // bank inline (logo left, title right) centered as a group
    const bankLogoEl = document.querySelector('#bankMeta img.bank-logo');
    const bankTitleElem = document.querySelector('#bankMeta .bank-title');
    const bankTitleTextToUse = bankTitleElem && bankTitleElem.textContent ? bankTitleElem.textContent.trim() : '';
    const maxTitleWidth = cardW - cardPadding*2 - bankLogoSize - 16;
    let titleLine1 = '', titleLine2 = '';
    if(bankTitleTextToUse){
      const words = bankTitleTextToUse.split(' ');
      for(let i=0;i<words.length;i++){
        const w = words[i];
        if(measureTextWidth((titleLine1 + ' ' + w).trim(), bankTitleFont) <= maxTitleWidth) titleLine1 = (titleLine1 + ' ' + w).trim();
        else titleLine2 = (titleLine2 + ' ' + w).trim();
      }
    }
    const titleWidth = Math.max(measureTextWidth(titleLine1, bankTitleFont), measureTextWidth(titleLine2||'', bankTitleFont));
    const groupWidth = bankLogoSize + 12 + titleWidth;
    const startX = Math.round(cardW/2 - groupWidth/2);

    // Clear bank error indicator
    bankErrorEl.style.display = 'none';

    if(bankLogoEl && bankLogoEl.src && includeBankLogoCheckbox.checked){
      let safe = null;
      if(bankLogoEl.src.startsWith && bankLogoEl.src.startsWith('data:')) safe = bankLogoEl.src;
      else safe = await fetchImageAsDataURL(bankLogoEl.src);
      if(safe){
        await drawImageContain(ctx, safe, startX, curY, bankLogoSize, bankLogoSize);
      } else {
        // fallback placeholder
        ctx.fillStyle = '#eef2ff'; roundRect(ctx, startX, curY, bankLogoSize, bankLogoSize, 10); ctx.fill();
        const short = (bankTitleTextToUse.split('—')[0]||bankTitleTextToUse.split(' ')[0]||'BN').trim().toUpperCase();
        ctx.fillStyle = '#1e40af'; ctx.font='700 24px Inter, Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(short, startX + bankLogoSize/2, curY + bankLogoSize/2);
        bankErrorEl.style.display = 'block';
      }
    } else {
      // If checkbox is unchecked, always show placeholder
      if(bankLogoEl){
        ctx.fillStyle = '#eef2ff'; roundRect(ctx, startX, curY, bankLogoSize, bankLogoSize, 10); ctx.fill();
        const short = (bankTitleTextToUse.split('—')[0]||bankTitleTextToUse.split(' ')[0]||'BN').trim().toUpperCase();
        ctx.fillStyle = '#1e40af'; ctx.font='700 24px Inter, Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(short, startX + bankLogoSize/2, curY + bankLogoSize/2);
      }
    }

    // draw title
    const titleX = startX + bankLogoSize + 12;
    ctx.fillStyle = '#0b1220'; ctx.font = bankTitleFont; ctx.textAlign = 'left'; ctx.textBaseline = 'top';
    if(titleLine1) ctx.fillText(titleLine1, titleX, curY + 2);
    if(titleLine2) ctx.fillText(titleLine2, titleX, curY + 20);

    curY += bankLogoSize + 8;
    if(titleLine2) curY += 6;

    // info rows
    const leftX = cardPadding + 12; const rightX = cardW - cardPadding - 12;
    const rows = [
      { label:'Số tài khoản', value: account },
      { label:'Chủ tài khoản', value: name.toUpperCase() },
      { label:'Số tiền', value: amount }
    ];
    for(let i=0;i<rows.length;i++){
      const r = rows[i];
      ctx.font = labelFont; ctx.fillStyle = 'rgba(15,23,42,0.6)'; ctx.textAlign='left'; ctx.textBaseline='top';
      ctx.fillText(r.label, leftX, curY);
      ctx.font = infoValueFont; ctx.fillStyle = '#0b1220'; ctx.textAlign='right';
      ctx.fillText(r.value, rightX, curY);
      curY += 20 + 8;
    }

    // combined
    ctx.font = combinedFont; ctx.fillStyle = '#0b1220'; ctx.textAlign = 'center';
    ctx.fillText(combined, cardW/2, curY + 4);

    // bottom note
    const bottomY = cardH - cardPadding - bottomNoteHeight + 6;
    ctx.font = '12px Inter, Arial'; ctx.fillStyle = 'rgba(11,18,32,0.55)'; ctx.textAlign = 'center'; ctx.textBaseline = 'top';
    ctx.fillText(bottomNote, cardW/2, bottomY);

    return canvas.toDataURL('image/png');
  }

  async function showFinalImage(){
    try{
      const dataUrl = await createFinalImageDataURL();
      previewCard.style.display = 'none';
      const existing = document.getElementById('finalImage'); if(existing) existing.remove();
      const img = document.createElement('img'); img.id='finalImage'; img.className='final-image'; img.src = dataUrl; img.alt='VietQR';
      finalImageContainer.appendChild(img);
      img.scrollIntoView({behavior:'smooth', block:'center'});
    }catch(e){
      console.error(e);
      showError(e.message || 'Không thể tạo ảnh cuối');
    }
  }

  /* ----------------- UI: load banks & events ----------------- */
  async function loadBanks(){
    try{
      const res = await fetch('https://api.vietqr.io/v1/banks');
      const json = await res.json();
      if(json && (json.code==='00' || json.code===200) && Array.isArray(json.data)){
        json.data.forEach(bank=>{
          const opt = document.createElement('option');
          opt.value = bank.bin || bank.acqId || bank.bin_number || '';
          const short = bank.short_name || bank.code || '';
          opt.textContent = `${short} — ${bank.name || ''}`;
          if(bank.logo) opt.dataset.logo = bank.logo;
          if(bank.logo_url) opt.dataset.logo = bank.logo_url;
          if(bank.name) opt.dataset.bankname = bank.name;
          if(bank.code) opt.dataset.code = bank.code;
          bankSelect.appendChild(opt);
        });
      } else console.warn('vietqr API trả về không chuẩn');
    }catch(e){ console.warn('Không load banks', e); }
    finally{ setDefaultValues(); }
  }

  function setDefaultValues(){
    const defaultBankKey = 'VIB';
    const defaultAccount = '087332665';
    const defaultName = 'BUI DIEU HUONG';
    const defaultStore = 'IN&Fun Studio';
    let foundIndex = -1;
    for(let i=0;i<bankSelect.options.length;i++){
      const opt = bankSelect.options[i];
      const text=(opt.textContent||'').toUpperCase();
      const code=(opt.dataset.code||'').toUpperCase();
      if(code === defaultBankKey || text.includes(defaultBankKey)){ foundIndex = i; break; }
    }
    if(foundIndex > 0){ bankSelect.selectedIndex = foundIndex; renderBankMeta(); }
    accountNumberInput.value = defaultAccount;
    accountNameInput.value = defaultName;
    storeCodeInput.value = defaultStore;
    cardFooterNote.textContent = 'In&Fun Studio - Xưởng Khắc dấu, In ấn, Thiết kế theo yêu cầu';
  }

  function makePlaceholderDataUrl(text){
    const initials = (text||'').split(' ').map(s=>s.trim()[0]||'').slice(0,2).join('').toUpperCase() || 'BN';
    const c=document.createElement('canvas'); c.width=120; c.height=120; const ctx=c.getContext('2d');
    ctx.fillStyle='#f1f5f9'; ctx.fillRect(0,0,120,120); ctx.fillStyle='#0f1724'; ctx.font='bold 44px Inter,Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(initials,60,64); return c.toDataURL('image/png');
  }

  function renderBankMeta(){
    bankMeta.innerHTML=''; infoTable.innerHTML='';
    const opt = bankSelect.options[bankSelect.selectedIndex]; if(!opt || !opt.value) return;
    const logoUrl = opt.dataset.logo || opt.dataset.logo_url || '';
    const bankname = opt.dataset.bankname || opt.textContent;
    const img = document.createElement('img'); img.className='bank-logo'; img.alt = bankname;
    if(logoUrl) img.src = logoUrl; else img.src = makePlaceholderDataUrl(bankname);
    const title = document.createElement('div'); title.className='bank-title'; title.textContent = opt.textContent;
    bankMeta.appendChild(img); bankMeta.appendChild(title);
    bankErrorEl.style.display = 'none';
  }

  // events
  document.getElementById('qr-form').addEventListener('submit', async (e)=>{
    e.preventDefault(); showError('');
    try{
      const acqId = bankSelect.value;
      const account = accountNumberInput.value;
      const name = accountNameInput.value;
      const amount = amountInput.value;
      const description = descriptionInput.value;
      const order = orderCodeInput.value;
      const store = storeCodeInput.value;

      if(!acqId || acqId.trim().length < 4) throw new Error('Vui lòng chọn ngân hàng.');
      if(!account || !account.trim()) throw new Error('Vui lòng nhập số tài khoản.');
      if(!name || !name.trim()) throw new Error('Vui lòng nhập tên chủ tài khoản.');

      const payload = buildVietQRPayload({ acqId, accountNumber: account, accountName: name, amount, description });
      payloadTextarea.value = payload;

      // render DOM preview QR
      const container = document.getElementById('qrcode'); container.innerHTML = '';
      new QRCode(container, { text: payload, width:260, height:260, correctLevel: QRCode.CorrectLevel.M });
      qrPlaceholder.style.display = 'none';

      renderBankMeta();
      infoTable.innerHTML = `
        <div class="info-row"><div class="info-label">Số tài khoản</div><div class="info-value">${account}</div></div>
        <div class="info-row"><div class="info-label">Chủ tài khoản</div><div class="info-value">${name.toUpperCase()}</div></div>
        <div class="info-row"><div class="info-label">Số tiền</div><div class="info-value">${amount && Number(amount)>0 ? Number(amount).toLocaleString('vi-VN')+' VND' : 'Không cố định'}</div></div>
      `;
      combinedTextEl.textContent = `${store||'-'} - ${order||'-'}`; combinedTextEl.style.display='block';

      // show logo preview if selected
      const f = logoInput.files && logoInput.files[0];
      if(!f){ logoPreview.style.display='none'; }

      // create final image and show
      await showFinalImage();
    }catch(err){
      console.error(err);
      showError(err.message || 'Có lỗi khi tạo QR');
    }
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    document.getElementById('qr-form').reset();
    const q = document.getElementById('qrcode'); q.innerHTML=''; const ex = document.getElementById('finalImage'); if(ex) ex.remove();
    previewCard.style.display='block'; qrPlaceholder.style.display = 'flex'; bankMeta.innerHTML=''; infoTable.innerHTML=''; combinedTextEl.style.display='none';
    setDefaultValues();
  });

  logoInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f){ logoPreview.src=''; logoPreview.style.display='none'; return; }
    const fr = new FileReader(); fr.onload = ()=>{ logoPreview.src = fr.result; logoPreview.style.display = 'block'; logoPreview.style.border = '8px solid #fff'; logoPreview.style.boxShadow='0 6px 18px rgba(15,23,42,0.06)'; }; fr.readAsDataURL(f);
  });

  document.getElementById('copyPayloadBtn').addEventListener('click', async ()=>{
    const text = payloadTextarea.value; if(!text) return showError('Không có chuỗi EMV để sao chép.');
    try{ await navigator.clipboard.writeText(text); showError('Đã sao chép'); setTimeout(()=>showError(''),1400);}catch(e){ showError('Trình duyệt không hỗ trợ sao chép'); }
  });

  document.getElementById('downloadBtn').addEventListener('click', async ()=>{
    try{ showError(''); const dataUrl = await createFinalImageDataURL(); const a=document.createElement('a'); a.href=dataUrl; a.download='vietqr_card.png'; document.body.appendChild(a); a.click(); a.remove(); }catch(e){ showError(e.message || 'Không thể tạo PNG'); }
  });

  bankSelect.addEventListener('change', ()=> renderBankMeta());
  document.addEventListener('DOMContentLoaded', ()=> loadBanks());
  </script>
</body>
</html>
